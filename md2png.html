<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>markdownいっぱつ画像化</title>
<link rel="stylesheet" type="text/css" href="https://unpkg.com/mvp.css">
<style>
body {
font-family: 
"Helvetica Neue",
Arial,
"BIZ UDPGothic",
"Yu Gothic UI Bold",
"Hiragino Kaku Gothic ProN",
"Hiragino Sans",
Meiryo,
sans-serif;
}
input[type="number"]{
  width: 3em;
}
main{
  font-family: "BIZ UDPGothic"!important;
  /* font-family: "Meiryo"!important; */
  /* font-family: "M+1VM+IPAG circle Regular"!important; */
  /* font-family: AoyagiKouzanFontGyousyo!important; */
  background-color: #eef;
  max-width: 1920px!important;
  height: 1006px;
  margin: 20px;
  padding: 0;
  /* background-image: url(bg2_blackboard_man.jpg); */
  background-size: cover;
 }
 #innertext{
  height: 1006px;
  max-width: 1920px;
  width: 1920px;
  display: table-cell;
  vertical-align: top;
 }
.pagetitle{
  font-size: 3rem;
}
dt{
  font-weight: bold;
  font-size: larger;
}
.pagesection{
  font-size: 1.5rem;
  padding: 0.5rem;
  color: white;
  background-color: black;
}
.shadow {
  font-size: 50px;
  -webkit-text-stroke-width: 1px;
  -webkit-text-stroke-color: white;
}
.shadow h1 {
color: red;
/* font-family: "BIZ UDPGothic"!important; */
font-family: "kirieji"!important;

margin: 5px;
font-size: 200px;
line-height: 220px;
font-weight: bold;
text-shadow: 10px 10px 0px #fff, 
-10px -10px 0px #fff, 
-10px 10px 0px #fff, 
10px -10px 0px #fff, 
10px 0px 0px #fff, 
-10px 0px 0px #fff, 
0px 10px 0px #fff, 
0px -10px 0px #fff;
text-wrap: nowrap;
-webkit-text-stroke-width: 6px;
-webkit-text-stroke-color: black;
}
.shadow h2 {
color: red;
font-size: 160px;
/* font-family: "BIZ UDPGothic"!important; */
/* font-family: "kirieji"!important; */

line-height: 170px;
margin: 3px;
font-weight: bold;
text-shadow: 2px 2px 0px #fff, -5px -5px 0px #fff, -5px 5px 0px #fff, 5px -5px 0px #fff, 5px 0px 0px #fff, -5px 0px 0px #fff, 0px 5px 0px #fff, 0px -5px 0px #fff;
-webkit-text-stroke-width: 5px;
-webkit-text-stroke-color: black;
}
.shadow h3 {
color: #ffa0a0;
/* font-family: "BIZ UDPGothic"!important; */
/* font-family: "kirieji"!important; */

font-size: 90px;
line-height: 100px;
margin: 3px;
font-weight: bold;
text-shadow: 2px 2px 0px #fff, -2px -2px 0px #fff, -2px 2px 0px #fff, 2px -2px 0px #fff, 2px 0px 0px #fff, -2px 0px 0px #fff, 0px 2px 0px #fff, 0px -2px 0px #fff;
-webkit-text-stroke-width: 3px;
-webkit-text-stroke-color: black;
}
li>input{
  white-space: nowrap;
  margin-right: 1em;
  display: inline;
}
.textsetting>li{
  margin: 0;
  padding: 0;
}
.textsetting>li>input{
  margin: 0;
  padding: 0;
  white-space: nowrap;
}
.input_px{
  width: 3em;
}
/* #padding_top, #padding_left{
  width: 3em;
} */
footer{
  border-top: 1px solid black;
  width: 100vw;
  margin: 0;
  max-width: 100vw;
  padding: 0px 20px;
}
</style>
</head>
<body>
<h1 class="pagetitle">Markdownいっぱつ画像化</h1>


<h2 class="pagesection">設定</h2>  

<!-- フォームを追加 -->
<div>
  <ul>
    <dt>テーマ</dt>
    <dd>
      <select id="theme" name="theme">
        <option value="std">標準</option>
        <option value="black_board_man" selected>黒板と男性イメージ</option>

      </select>      
    </dd>
    <dt>markdownテキスト</dt>
    <dd>
      <button id="clear_button">テキストをリセット</button>
      <textarea id="textarea" name="textarea" rows="10" cols="50">
### 文字入りの画像は
## 目立つ！

紛らわしい文字たち
oO08 iIlL1 g9qCGQ ハバパヘベペ

**bold** *italic*
 
|       | 1列目 | 2列目 | 3列目 |
|-------|-------|-------|-------|
| 1行目 | 1-1   | 1-2   | 1-3   |
| 2行目 | 2-1   | 2-2   | 2-3   |

***fontname***
</textarea>
    </dd>
    <dt>テキストスタイル</dt>
    <dd>
      <details>
          <ul class="textsetting">
            <li>サイズ：<input type="number" id="text_size"           value="50"      name="text_size" min="10" max="100">&nbsp;px</li>
            <li>文字色：<input type="color"  id="text_color"          value="#000000" name="text_color"></li>
            <li>太字　：<input type="radio"  id="text_weight_bold"    value="bold"    name="text_weight"> Yes 
                        <input type="radio"  id="text_weight_normal"  value="normal"  name="text_weight" checked> No</li>
            <li>斜体　：<input type="radio"  id="text_style_italic"   value="italic"  name="text_style"> Yes
                        <input type="radio"  id="text_style_normal"   value="normal"  name="text_style" checked> No</li>
            <li>縁　１：太さ&nbsp;<input type="number" id="text_t_e1" value="2"       name="text_t_e1" min="0">px; &nbsp;
                        色&nbsp;<input type="color"    id="text_c_e1" value="#000000" name="text_c_e1"></li>
            <li>縁　２：太さ&nbsp;<input type="number" id="text_t_e2" value="2"       name="text_t_e2" min="0">px; &nbsp;
                        色&nbsp;<input type="color"    id="text_c_e2" value="#ffffff" name="text_c_e2"></li>
          </ul>
      </details>
    </dd>
    <dt>H2テキストスタイル（大見出し）</dt>
    <dd>
    </dd>
    <dt>H3テキストスタイル（小見出し）</dt>
    <dd>
    </dd>
    <dt>テキスト配置</dt>
    <dd>
      <div>
        <input type="radio" id="left_align" name="textalign" value="left" checked>
        <label for="left_align">左寄せ</label>
        <input type="radio" id="center_align" name="textalign" value="center">
        <label for="center_align">センタリング</label>
        <input type="radio" id="right_align" name="textalign" value="right">
        <label for="right_align">右寄せ</label>
      </div>    
    </dd>
    <dd>
      <div>
        <input type="radio" id="top_align" name="textvalign" value="top" checked>
        <label for="top_align">上端揃え</label>
        <input type="radio" id="middle_align" name="textvalign" value="middle">
        <label for="middle_align">中央揃え</label>
        <input type="radio" id="bottom_align" name="textvalign" value="bottom">
        <label for="bottom_align">下端揃え</label>
      </div>    
    </dd>
    <dd>
      <ul>
        <li>top: <input type="number" id="padding_top"  name="padding_top"  value="100">px</li>
        <li>left:<input type="number" id="padding_left" name="padding_left" value="100">px</li>
      </ul>
    </dd>
    <dt>背景画像選択</dt>
    <dd>  <input type="file" id="imageFile" accept="image/png, image/jpeg"></dd>
  </ul>
  <button id="update_button">更新・ダウンロード</button>
  <button id="save_button">ダウンロード</button>

</div>

<h2 class="pagesection">プレビュー</h2>
<main id="target" class="shadow">
<div id="innertext" class="l-main-editer js-markdown-editer">
### 文字入りの画像は
## 目立つ！

紛らわしい文字たち
oO08 iIlL1 g9qCGQ ハバパヘベペ

**bold** *italic*

|       | 1列目 | 2列目 | 3列目 |
|-------|-------|-------|-------|
| 1行目 | 1-1   | 1-2   | 1-3   |
| 2行目 | 2-1   | 2-2   | 2-3   |
</div>
</main>
<footer>
  <p>
    &copy; <a href="https://note.com/koji_doi.html">Koji Doi</a>. 2024. 
  </p>
</footer>

<!-- JS -->
<script src="https://code.jquery.com/jquery-1.9.1.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/8.2.2/markdown-it.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
  //// DEFAULT VALUES ////
  const vals ={
    std:{
      text_size:     '50',     // text font size [px]
      text_color:    '#000000',// text color
      text_weight:   'normal', // normal or bold
      text_style:    'normal', // normal or italic
      text_t_e1:     '2',      // text stroke thickness
      text_c_e1:     '#000000',// text stroke color
      text_t_e2:     '2',      // text shadow width
      text_c_e2:     '#ffffff',// text shadow color
      h2text_size:   '50',     // text font size [px]
      h2text_color:  '#000000',// text color
      h2text_weight: 'normal', // normal or bold
      h2text_style:  'normal', // normal or italic
      h2text_t_e1:   '2',      // text stroke thickness
      h2text_c_e1:   '#000000',// text stroke color
      h2text_t_e2:   '2',      // text shadow width
      h2text_c_e2:   '#ffffff',// text shadow color
      h3text_size:   '50',     // text font size [px]
      h3text_color:  '#000000',// text color
      h3text_weight: 'normal', // normal or bold
      h3text_style:  'normal', // normal or italic
      h3text_t_e1:   '2',      // text stroke thickness
      h3text_c_e1:   '#000000',// text stroke color
      h3text_t_e2:   '2',      // text shadow width
      h3text_c_e2:   '#ffffff',// text shadow color
      emtext_size:   '50',     // empahasized(em) text font size [px]
      emtext_color:  '#000000',// empahasized(em) text color
      emtext_weight: 'normal', // empahasized(em) normal or bold
      emtext_style:  'normal', // empahasized(em) normal or italic
      emtext_t_e1:   '2',      // empahasized(em) text stroke thickness
      emtext_c_e1:   '#000000',// empahasized(em) text stroke color
      emtext_t_e2:   '2',      // empahasized(em) text shadow width
      emtext_c_e2:   '#ffffff',// empahasized(em) text shadow color
      sttext_size:   '50',     // strong text font size [px]
      sttext_color:  '#000000',// strong text color
      sttext_weight: 'normal', // strong normal or bold
      sttext_style:  'normal', // strong normal or italic
      sttext_t_e1:   '2',      // strong text stroke thickness
      sttext_c_e1:   '#000000',// strong text stroke color
      sttext_t_e2:   '2',      // strong text shadow width
      sttext_c_e2:   '#ffffff',// strong text shadow color
      thtext_size:   '50',     // header cell (th) text font size [px]
      thtext_color:  '#000000',// header cell (th) text color
      thtext_weight: 'normal', // header cell (th) normal or bold
      thtext_style:  'normal', // header cell (th) normal or italic
      thtext_t_e1:   '2',      // header cell (th) text stroke thickness
      thtext_c_e1:   '#000000',// header cell (th) text stroke color
      thtext_t_e2:   '2',      // header cell (th) text shadow width
      thtext_c_e2:   '#ffffff',// header cell (th) text shadow color
      tdtext_size:   '50',     // cell (td) text font size [px]
      tdtext_color:  '#000000',// cell (td) text color
      tdtext_weight: 'normal', // cell (td) normal or bold
      tdtext_style:  'normal', // cell (td) normal or italic
      tdtext_t_e1:   '2',      // cell (td) text stroke thickness
      tdtext_c_e1:   '#000000',// cell (td) text stroke color
      tdtext_t_e2:   '2',      // cell (td) text shadow width
      tdtext_c_e2:   '#ffffff',// cell (td) text shadow color

      textalign:     'left',   // text horizontal align
      textvalign:    'top',    // text vertical align
      padding_left:  '0',      // left padding [px]
      padding_top:   '0',      // top padding [px]
      imagefile:     ''        // background image file name (jpeg/png)
    },
    black_board_man:{
      text_color:  '#ffff00',
      text_size:   '70',
      text_weight: 'bold',
      padding_left:  '100'
    }
  };
  //// END of DEFAULT VALUES ////

  // standard theme = 'std'
  let std_v = vals['std'];

  function theme_val(theme, propname){
    if(typeof theme =="undefined"){
      theme = 'std';
    }
    if(!(theme in vals)){
      return(undefined);
    }
    if(propname in vals[theme]){
      return(vals[theme][propname]);
    }else{
      return(vals['std'][propname]);
    }
  }

  function shadow_val(t, c){
    t = t.replace(/(\d+)$/, '$1px');
    return( `${t}  ${t} 0 ${c}, `
         + `-${t} -${t} 0 ${c}, `
         + `-${t}  ${t} 0 ${c}, `
         + ` ${t} -${t} 0 ${c}, `
         + ` ${t}  0    0 ${c}, `
         + `-${t}  0    0 ${c}, `
         + ` 0     ${t} 0 ${c}, `
         + ` 0    -${t} 0 ${c}`);
  }

  function id2propname(id){
    return(id.match("c_e1")         ? "-webkit-text-stroke-color"
         : id.match("t_e1")         ? "-webkit-text-stroke-width"
         : id.match("c_e2")         ? "textShadow"
         : id.match("t_e2")         ? "textShadow"
         : id.match("color")        ? "color"
         : id.match("size")         ? "fontSize" 
         : id.match("weight")       ? "fontWeight" 
         : id.match("style")        ? "fontStyle"
         : id.match("valign")       ? "verticalAlign"
         : id.match("align")        ? "textAlign"
         : id.match("padding_top")  ? "paddingTop"
         : id.match("padding_left") ? "paddingLeft" : '');
  }

  // すべての要素に対して指定されたCSSプロパティを更新
  function updateCSSProperty(selector, property, value) {
    const elements = document.querySelectorAll(selector);  
    elements.forEach(element => {
        element.style[property] = value;
    });
  }

  // テキスト入力欄を空に
  document.getElementById('clear_button').addEventListener('click', function() {
    document.getElementById('textarea').value = "";
  });

  // make png file
  document.getElementById('save_button').addEventListener('click', function() {
    downloadElAsPng();
  });

  // form 変更反映
  let csssel   = {text:"#innertext p", h2text:"#innertext h2", h3text:"#innertext h3", em:"#innertext em", strong:"#innertext strong"};
  ["text"].map(
  // **bold** -> <strong>bold</strong> font-weight: bold
  // *italic* -> <em>italic</em>       font-style: italic
    (target) => {
      ["color","size","c_e1","t_e1","c_e2","t_e2"].map(
        (p0) => {
          let p = target + "_" + p0;
          document.getElementById(p).addEventListener('change', function(){
            let p_val = document.getElementById(p).value;
            let t_e2  = target + "_t_e2";
            let c_e2  = target + "_c_e2";
            let prop = p.match("c_e1")  ? ["-webkit-text-stroke-color", p_val] 
                     : p.match("t_e1")  ? ["-webkit-text-stroke-width", p_val+"px"]
                     : p.match("c_e2")  ? ["textShadow", ((std_v[c_e2]=p_val), shadow_val(std_v[t_e2], std_v[c_e2]))]
                     : p.match("t_e2")  ? ["textShadow", ((std_v[t_e2]=p_val), shadow_val(std_v[t_e2], std_v[c_e2]))]
                     : p.match("color") ? ["color" , p_val]
                     : p.match("size")  ? ["fontSize", p_val+"px"] :[];
            updateCSSProperty(csssel[target], prop[0], prop[1]);
            console.log("chg ", eventtype, target, prop[0], prop[1]);
          });
        } // p0
      ); // map for color size etc.

      ["weight","style"].map(
        (p0) => {
          let p = target + "_" + p0;
          document.querySelectorAll(`input[name="${p}"]`).forEach(function(radio) {
            radio.addEventListener('change', function() {
              let prop = (p0=="weight") ? "fontWeight" : "fontStyle";
              updateCSSProperty(csssel[target], prop, this.value);
            });    
          });
        });
    } // target
  );

  document.querySelectorAll('input[name="text_align"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
      updateCSSProperty('main', 'textAlign', this.value);
    });
  });
  document.querySelectorAll('input[name="text_valign"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
      const innertext = document.querySelector('#innertext');
      console.log("valign ", this.value);
      // main.offsetHeight が1006のはず。
      //innertext.style.vertical_align = this.value;
      var targetDiv = document.getElementById("innertext");
      if (targetDiv) {
        targetDiv.style.display = "table-cell";
        targetDiv.style.verticalAlign = this.value;
      }
    });
  });
  document.querySelectorAll('input[name="padding_top"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
      let padding_top = document.getElementById('padding_top').value;
      document.querySelector("#innertext").style.paddingTop = padding_top+"px";
    });
  });
  document.querySelectorAll('input[name="padding_left"]').forEach(function(radio) {
    radio.addEventListener('change', function() {
      let padding_left = document.getElementById('padding_left').value;
      document.querySelector("#innertext").style.paddingLeft = padding_left+"px";
    });
  });

  document.getElementById('textarea').addEventListener('change', function() {
    // テキスト入力フォームの内容を取得
    var textInput = document.getElementById('textarea').value;

    // mainブロック内にテキストを追記
    const main = document.querySelector('main');

    // 隠し機能：使用フォント名を追記する
    textInput = textInput.replace("***fontname***", getComputedStyle(document.querySelector('main')).font);

    const md = markdownit({
    html: true,
    linkify: true,
    typographer: true
    });

    // md -> html
    var htmltxt = md.render(textInput);
    let innertext = document.getElementById('innertext');
    innertext.innerHTML = htmltxt;
  }); //document.getElementById('#textarea')

  document.getElementById('imageFile').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = function() {
        const base64String = reader.result;
        const main = document.querySelector('main');
        main.style.backgroundImage = `url(${base64String})`;
      };
      reader.readAsDataURL(file);
    }
  });

  document.getElementById('theme').addEventListener('change', function(event) {

  });

// マークダウンの基本設定

const markdown_setting = window.markdownit({
  html: true, // htmlタグを有効にする
  breaks: true, // md内の改行を<br>に変換
});

const markdown_editer = $(".js-markdown-editer");
// マークダウンの設定をjs-markdown-editerにHTMLとして反映させる
const markdown_html = markdown_setting.render(getHtml(markdown_editer));
markdown_editer.html(markdown_html);

// 比較演算子（=，<>，<，<=，>，>=）をそのまま置換する
function getHtml(selector) {
  let markdown_text = $(selector).html();
  // let markdown_text = document.querySelectorAll(selector)[1].innerHTML;
  markdown_text = markdown_text.replace(/&lt;/g, );
  markdown_text = markdown_text.replace(/&gt;/g, );
  markdown_text = markdown_text.replace(/&amp;/g, );
  return markdown_text;
}

// https://khsmty.com/article/html2canvas-image-download/
function downloadElAsPng() {
  const el = document.querySelector("main");
  if (!el) {
    console.error("要素が見つかりませんでした。");
    return;
  }

  html2canvas(el).then((canvasEl) => {
    const aEl = document.createElement("a");
    aEl.href = canvasEl.toDataURL("image/png");
    aEl.download = "md_snapshot.png";
    aEl.click();
    }
  );
};

//Default values for the selected theme
let theme = document.getElementById('theme').value;
const inputs = document.querySelectorAll('input');

// Set input form parameters, and reflect to innertext
inputs.forEach(input => {
  const inputName = input.name;
  const v = theme_val(theme, inputName);
  const prop = id2propname(inputName);
  let e0;
  let target_tag;
  if(e0 = inputName.match("padding_(top|left)")){
    target_tag = '';
    console.log("#padding ",e0[0], v);
    updateCSSProperty('main', id2propname(e0[0]), v+"px");
  }else if(e0 = inputName.match("textv?align")){
    console.log("align");
  }else if(e0 = inputName.match("^(h2|h3|em|st|th|td)?([a-zA-Z0-9]+)_")){
    try{
      target_tag = (typeof e0[1] === 'undefined') ? 'p' : (e0[1] == 'st') ? 'strong' : e0[1];
    }catch(e){
      console.log("What's wrong for input? ", input.innerText);
      console.log(e0);
    }
    if (v !== undefined) {
      console.log("id ", input.id, " name ", input.name, " prop ", prop, " v ", v);
      if (input.type === "radio") {
        if (input.value === v) {
          input.checked = true;
        }
        let vv = input.id.match("_([a-zA-Z0-9]+)$")[1];
        if(vv == v){
          document.querySelectorAll(`#innertext ${target_tag}`).forEach((e1)=>{
            try{
              console.log(prop, e1.innerHTML);
              e1.style[prop] = v;
            }catch(er){
              console.log(er)
            }
          })
        }
      } else if (input.type === "number" || input.type === "color" || input.type === "file") {
       input.value = v;
      }
    }
    updateCSSProperty('#innertext', prop, v);
  }
});
/* Object.keys(vals['std']).forEach(
  (k) => {
    let v = theme_val(theme, k);
    try{
      const inputs = document.querySelectorAll(`#${formId} input`);

inputs.forEach(input => {

      if (input.type === "radio") {
            if (input.value === defaultvals[inputName]) {
                input.checked = true;
            }
        } else if (input.type === "number" || input.type === "color") {
            input.value = defaultvals[inputName];
        }
      document.getElementById(k).value = v;
      //console.log(`*** ${theme} ${k}: ${v}`)
    }
    catch(e){console.log("error: ", k,v,e)}
  }
); */
</script>
</body>
</html>